<!DOCTYPE html>
<html lang="en">
<head>
  <title>SimpleVideoCompareTool</title>
  <meta charset="UTF-8">

  <link rel="stylesheet" href="BeerSlider.unmin.css">
  <script src="BeerSlider.unmin.js"></script>

  <script src="jquery-3.3.1.min.js"></script>
  <script src="jquery.event.move.js"></script>
  <script src="mp4box.all.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <style>
      .dragover {
          background:rgb(193, 225, 255);
      }
      .boxspan {
        display: inline-block;
        width: 100%;
        text-align: center;
        line-height:50px;
      }
      .videoItem {
        flex: 1;
        aspect-ratio: auto;
        border: 1px solid black;
      }
      .collapsible {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
      }

      /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
      .active, .collapsible:hover {
        background-color: #ccc;
      }
      /* Style the collapsible content. Note: hidden by default */
      .content {
        display: none;
        overflow: hidden;
        background-color: #f1f1f1;
      }
</style>
</head>
<body>

  <div style="margin: 10px;">
      <div style="width: 100%; display: flex; ">
          <div id="drop-zoneL" style="height: 50px; width: 100%; border: thin solid #888888;"><span class="boxspan">Left Video (Please drop your video/folder here)</span></div>
          <div style="width: 20px;"></div>
          <div id="drop-zoneR" style="height: 50px; width: 100%; border: thin solid #888888;"><span class="boxspan">Right Video (Please drop your video/folder here)</span></div>
      </div>
  </div>
  <div style="display: flex;">
    <select id="filesL" style="flex: 1;max-width: 50%;"> 
      <option value="">--fileList--</option>
    </select> 
    <select id="filesR" style="flex: 1;max-width: 50%;"> 
      <option value="">--fileList--</option>
    </select> 
  </div>

  <div id="frameLabel">frame: 0</div>
    <label for="playbackSpeed">Speed:</label>
    <select id="playbackSpeed" name="playbackSpeed" onchange="onPlaybackSpeedChange();">
      <option value="100%">100%</option>
      <option value="50%">50%</option>
      <option value="33%">33%</option>
      <option value="10%">10%</option>
    </select>
  <button type="button" id="buttonPlay" style="height: 30px;" onclick="playSync()">Play</button>
  <button type="button" id="buttonStop" style="height: 30px;" onclick="stopSync()">Stop</button>
  <button type="button" id="buttonPrev" style="height: 30px;" onclick="framePrev()">&lt;= Prev</button>
  <button type="button" id="buttonNext" style="height: 30px;" onclick="frameNext()">Next =&gt;</button>
  <div style="height: 10px;"></div>
  <div>HotKeys( d/f: frame seek, space: play or stop )</div>
  <div style="height: 10px;"></div>

  <button type="button" class="collapsible">PSNR HeatMap</button>
  <div class="content" style="margin: 0;">
    <img src="map_label.png"><br>
    <div>Note: Sometimes, heatmap can wrongly be calculated due to difficulity of perfect video frame synchronization. You can try to seek to the frame or play with a slower speed.</div>
    <label for="MaxPSNR">Max PSNR:</label>
    <input type="number" id="MaxPSNR" value="35" min="0" step="1" style="width: 64px;font-size: 16px;" onchange="updateHeatmap()">
    <label for="MinPSNR">Min PSNR:</label>
    <input type="number" id="MinPSNR" value="20" min="0" step="1" style="width: 64px;font-size: 16px;" onchange="updateHeatmap()">
    <canvas id="heatmap" style="width: calc(100% - 4px); height:32px; background-color: black; margin-left: 4px;"></canvas>
  </div>
  <!-- oninput="onSeekbarChange(this.value)" -->
  <input type="range" min="0" max="100" value="0" id="seekbar" style="width: 100%" onchange="onSeekbarChange(this.value)" oninput="onSeekbarChange(this.value)" >
  <div style="height: 10px;"></div>
  <input type="checkbox" name="Playback Range" id="playbackRange" value="0" onchange="updateUI()">Playback Range<br>
  <div id="playRange" style="margin: 8px;"></div>

  <button type="button" id="compare" style="height: 30px;" onclick="compare()">Compare current frame</button>

  <div style="height: 10px;"></div>
  
  <div class="container" style="display: flex;">
    <video id="LHSImage" class="videoItem" style="width: 49%; border-color: blue;"></video>
    <video id="RHSImage" class="videoItem" style="width: 49%; border-color: red"></video>
  </div>

  <!-- Loupe Feature -->
  <div style="display: flex; justify-content: center; align-items: baseline; position: absolute; left: 0px; top: 0px; z-index: 10;" id="uicontainerL">
    <canvas id="uicanvasL" style="max-width:100%; height:auto;" oncontextmenu="return false;">  
  </div>
  <div style="display: flex; justify-content: center; align-items: baseline; position: absolute; left: 0px; top: 0px; z-index: 10;" id="uicontainerR">
    <canvas id="uicanvasR" style="max-width:100%; height:auto;" oncontextmenu="return false;">
  </div>

  <div style="height: 10px;"></div>
  <div>
    <label>
      Loupe Box
      <input type="range" id="loupe" min="64" max="1024" value="512" oninput="onLoupe(this.value)" onchange="onLoupe(this.value)"/>
    </label>
    <div>Left drag: move box (dragging it to outside to remove), middle click: video LR Flip, right click: show difference</div>
  </div>
  
  <div style="height: 10px;"></div>

  <div class="compContainer" style="display: flex; justify-content: center; align-items: center; display: none;">
    <div id="slider" class="beer-slider" data-beer-label=dogs-after.jpg style="border: 1px solid #000000;">
      <img src="dogs-after.jpg" alt="Original man holding beer" id="compR">
      <div class="beer-reveal" data-beer-label="dogs-before.jpg" id="BeforeLabel">
        <img src="dogs-before.jpg" alt="Processed with logo and Lightroom presets" id="compL">
      </div>
    </div>
  </div>

  <div class="compContainer" style="margin:10px; padding:10px; border:1px solid black; display: none;">
  <p>
    <input type="checkbox" name="hide" value="0" onchange="didChangeHideHandle(this.checked)">Hide Handle<br>
    <input type="checkbox" name="hide" value="0" onchange="didChangeDifferenceMode(this.checked)">Difference Mode<br>
  </p>
  </div>

  <script>
    const uicanvasL = document.getElementById('uicanvasL');
    const uicanvasR = document.getElementById('uicanvasR');

    beer = new BeerSlider( document.getElementById( "slider" ) ); 
    
    var dragoverHandler = function(e){
        e.preventDefault();
        $(this).addClass("dragover");
    };
    $("#drop-zoneL").on("dragover", dragoverHandler);
    $("#drop-zoneR").on("dragover", dragoverHandler);

    var dragleaveHandler = function(e){
        e.preventDefault();
        $(this).removeClass("dragover");
    };
    $("#drop-zoneL").on("dragleave", dragleaveHandler);
    $("#drop-zoneR").on("dragleave", dragleaveHandler);

    var isHeatmapEnabled = false;
    $('.collapsible').click(function() {
        var content = $(this).next();
        content.slideToggle(100, function() {
          updateCanvasLayout();
        });
        content.toggleClass('open');
        isHeatmapEnabled = content.hasClass('open');
    });
    
    var image_L_idx = "LHSImage";
    var image_R_idx = "RHSImage";

    var videoFrames = 0;
    var busyCounter = 0;
    var currentFrame = 0;
    var playingCount = 0;

    var offScreenCanvas = document.createElement('canvas');

    var mouseL = { x: -1000, y: -1000};
    var mouseR = { x: -1000, y: -1000};
    var dragging = false;
    var loupeSize = 512;
    var mouseButton = 0;
    var diffViewIndex = 0;

    function onLoupe(value)
    {
      loupeSize = value;
      canvasRender();
    }

    function onMouseDown( event )
    {
      dragging = true;
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      mouseButton = event.button;
      if(mouseButton === 0)
      {
        mouseL = getMousePos( uicanvasL, event );
        mouseR = getMousePos( uicanvasR, event );
      }
      if(mouseButton == 2)
      {
        const m = getMousePos( uicanvasL, event );
        diffViewIndex = m.x < uicanvasL.width ? 0 : 1;
      }
      canvasRender();
      event.preventDefault();
    }
    $(uicanvasL).mousedown(onMouseDown);
    $(uicanvasR).mousedown(onMouseDown);

    $(document).mouseup(function() {
        dragging = false; 
        canvasRender();
    });

    function getMousePos(canvas, event) {
      var rect = canvas.getBoundingClientRect(),
        scaleX = canvas.width / rect.width,
        scaleY = canvas.height / rect.height;

      return {
        x: (event.pageX - rect.left) * scaleX,
        y: (event.pageY - rect.top) * scaleY
      }
    }
    $(document).mousemove(function(event) {
      if(dragging == false)
      {
        return;
      }
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      if(mouseButton === 0)
      {
        mouseL = getMousePos( uicanvasL, event );
        mouseR = getMousePos( uicanvasR, event );
      }
      canvasRender();
    });
    
    function canvasRender()
    {
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      // mouseR = getMousePos( uicanvasR );
      // mouseL = getMousePos( uicanvasL );
      
      const ctxR = uicanvasR.getContext("2d");
      const ctxL = uicanvasL.getContext("2d");
      
      const boxSize = loupeSize;
      const lineWidth = 5;
      const videoFlip = mouseButton === 1 && dragging;
      const useDiff   = mouseButton === 2 && dragging;

      const viewScale = uicanvasL.width / uicanvasL.getBoundingClientRect().width;

      // Right
      ctxR.clearRect(0, 0, uicanvasR.width, uicanvasR.height);

      function drawLabel( ctx, label )
      {
        ctx.save();
        const fontsize = 24 * viewScale;
        ctx.font = fontsize + "px Arial";
        ctx.fillStyle = "red";
        ctx.strokeStyle = "white";
        ctx.lineWidth = parseFloat(fontsize) / 6.0;
        ctx.lineJoin = "round";
        ctx.strokeText(label, 32, fontsize);
        ctx.fillText(label, 32, fontsize);
        ctx.restore();
      }
      function drawDiff( ctx )
      {
        ctx.save();
        ctx.drawImage(videoR, 
          0, 0, uicanvasL.width, uicanvasL.height,
          0, 0, uicanvasL.width, uicanvasL.height); 
        ctx.globalCompositeOperation = "difference";
        ctx.drawImage(videoL, 
          0, 0, uicanvasL.width, uicanvasL.height,
          0, 0, uicanvasL.width, uicanvasL.height); 
          ctx.restore();
      }

      const isHoverOnRight = 0 < mouseR.x && 0 < mouseR.y && mouseR.x < uicanvasR.width && mouseR.y < uicanvasR.height;
      const isHoverOnLeft = 0 < mouseL.x && 0 < mouseL.y && mouseL.x < uicanvasL.width && mouseL.y < uicanvasL.height;

      if( videoFlip || useDiff || isHoverOnRight )
      {
        if( isHoverOnRight )
        {
          ctxR.drawImage(videoL, 
            mouseR.x, mouseR.y - boxSize, boxSize, boxSize,
            mouseR.x - boxSize, mouseR.y - boxSize, boxSize, boxSize); 
  
          ctxR.lineWidth = lineWidth;
          ctxR.strokeStyle = "blue";
          ctxR.strokeRect (mouseR.x - boxSize, mouseR.y - boxSize, boxSize, boxSize); // L
    
          ctxR.strokeStyle = "red";
          ctxR.strokeRect (mouseR.x, mouseR.y - boxSize, boxSize, boxSize); // R
        }

        if( videoFlip )
        {
          ctxR.drawImage(videoL, 
            0, 0, uicanvasL.width, uicanvasL.height,
            0, 0, uicanvasL.width, uicanvasL.height); 

          drawLabel(ctxR, 'LR flipped');
        }
        if( useDiff && diffViewIndex == 1 )
        {
          drawDiff(ctxR);
          drawLabel(ctxR, 'Difference');
        }
      }

      ctxL.clearRect(0, 0, uicanvasL.width, uicanvasL.height);
      if( videoFlip || useDiff || isHoverOnLeft )
      {
        if(isHoverOnLeft)
        {
          ctxL.drawImage(videoR, 
            mouseL.x - boxSize, mouseL.y - boxSize, boxSize, boxSize,
            mouseL.x, mouseL.y - boxSize, boxSize, boxSize); 
          
          ctxL.lineWidth = lineWidth;
          ctxL.strokeStyle = "blue";
          ctxL.strokeRect (mouseL.x - boxSize, mouseL.y - boxSize, boxSize, boxSize); // L
    
          ctxL.strokeStyle = "red";
          ctxL.strokeRect (mouseL.x, mouseL.y - boxSize, boxSize, boxSize); // R
        }

        if( videoFlip )
        {
          ctxL.drawImage(videoR, 
            0, 0, uicanvasL.width, uicanvasL.height,
            0, 0, uicanvasL.width, uicanvasL.height); 
            drawLabel(ctxL, 'LR flipped');
        }
        if( useDiff && diffViewIndex == 0 )
        {
          drawDiff(ctxL);
          drawLabel(ctxL, 'Difference');
        }
      }
    }

    function readEntryAll( directoryReader, onRead )
    {
      directoryReader.readEntries((entries) => {
        if(entries.length == 0)
        {
          return;
        }

        onRead(entries);

        readEntryAll(directoryReader, onRead);
      });
    }

    function updateCanvasLayout()
    {
      const LC = $("#" + image_L_idx);
      var offsetL = LC.offset();

      $('#uicontainerL')
          .css('left', offsetL.left + 1)
          .css('top', offsetL.top + 1)
          .width (LC.width())
          .height(LC.height());

      const RC = $("#" + image_R_idx);
      var offsetR = RC.offset();

      $('#uicontainerR')
          .css('left', offsetR.left + 1)
          .css('top', offsetR.top + 1)
          .width (RC.width())
          .height(RC.height());

      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      uicanvasL.width = videoL.videoWidth;
      uicanvasL.height = videoL.videoHeight;
      uicanvasR.width = videoR.videoWidth;
      uicanvasR.height = videoR.videoHeight;

      canvasRender();
    }
    $(document).ready(function() { 
      $(window).resize(updateCanvasLayout);
      updateCanvasLayout();
    }); 

    let videoElements = {
      '#filesL' : [null],
      '#filesR' : [null],
    }; 

    function scanFiles(item, selection_id) {
     if( item.name.endsWith('.mp4') )
     {
      index = videoElements[selection_id].length;
      videoElements[selection_id].push(item);
      $(selection_id).append($('<option>', { 
        value: index,
        text : item.fullPath 
      }));
     }

      if (item.isDirectory) {
        let directoryReader = item.createReader();
        
        // readEntries only reads limited number of elements, insane API.
        // directoryReader.readEntries((entries) => {
        //   entries.forEach((entry) => {
        //     scanFiles(entry, selection_id);
        //   });
        // });

        readEntryAll( directoryReader, (entries) => {
          entries.forEach((entry) => {
            scanFiles(entry, selection_id);
          });
        });
      }
    }

    function onVideoChanged( item, image_idx )
    {
      item.file( ( file ) => {
        currentFrame = 0;

        const video = document.getElementById(image_idx);
        video.src = URL.createObjectURL(file);
        video.onended = onVideoEnd;
        video.load();
        video.addEventListener('loadeddata', function() {
          updateUI();
        }, false);

        const arrayReader = new FileReader();
        arrayReader.onload = function(e) {
            const arrayBuffer = e.target.result;
            const mp4box = new MP4Box.createFile();
            mp4box.onReady = function(info) {
                console.log('Metadata:', info);
                videoFrames = info.tracks[0].nb_samples;
            };
            mp4box.onError = function(e) { console.log(e); };
            arrayBuffer.fileStart = 0;
            mp4box.appendBuffer((arrayBuffer));
            mp4box.flush();
        };
        arrayReader.readAsArrayBuffer(file);
      });
    }
    
    function synchronizeElement( selector, item )
    {
      const indexInOthers = videoElements[selector].findIndex( ( elem ) => elem != null && elem.name === item.name );
      if( 0 <= indexInOthers )
      {
        $(selector).val(indexInOthers);
        $(selector).trigger("change");
      }
    }

    $('#filesL').on('change', function( e ) {
      if( this.value === "" )
      {
        return;
      }
      let item = videoElements['#filesL'][parseInt(this.value)];
      onVideoChanged( item, image_L_idx );

      if( e.hasOwnProperty("originalEvent") )
      {
        synchronizeElement( '#filesR', item )
      }
    });
    $('#filesR').on('change', function( e ) {
      if( this.value === "" )
      {
        return;
      }
      let item = videoElements['#filesR'][parseInt(this.value)];
      onVideoChanged( item, image_R_idx );

      if( e.hasOwnProperty("originalEvent") )
      {
        synchronizeElement( '#filesL', item )
      }
    });

    var handleDrop = function(e, image_idx, selector_label, selection_id ) {
        e.preventDefault();

        var file = e.originalEvent.dataTransfer.files[0];

        const supportsWebkitGetAsEntry = 'webkitGetAsEntry' in DataTransferItem.prototype;
        if(supportsWebkitGetAsEntry)
        {
          if( image_idx === image_L_idx )
          {
            $('#filesL').empty();
            $('#filesL').append($('<option>', { 
              value: 0,
              text : "--fileList--",
            }));
            videoElements['#filesL'] = [null];
          }
          else
          {
            $('#filesR').empty();
            $('#filesR').append($('<option>', { 
              value: 0,
              text : "--fileList--",
            }));
            videoElements['#filesR'] = [null];
          }

          let item = event.dataTransfer.items[0].webkitGetAsEntry();

          if (item.isDirectory) {
            scanFiles(item, selection_id);

            return;
          }
        }

        currentFrame = 0;

        const video = document.getElementById(image_idx);
        video.src = URL.createObjectURL(file);
        video.onended = onVideoEnd;
        video.load();
        video.addEventListener('loadeddata', function() {
          updateUI();
        }, false);

        const arrayReader = new FileReader();
        arrayReader.onload = function(e) {
            const arrayBuffer = e.target.result;
            const mp4box = new MP4Box.createFile();
            mp4box.onReady = function(info) {
                console.log('Metadata:', info);
                videoFrames = info.tracks[0].nb_samples;
            };
            mp4box.onError = function(e) { console.log(e); };
            arrayBuffer.fileStart = 0;
            mp4box.appendBuffer((arrayBuffer));
            mp4box.flush();
        };
        arrayReader.readAsArrayBuffer(file);
    };
    function onPlaybackSpeedChange()
    {
      const playbackSpeed = $('[name="playbackSpeed"] option:selected').val();
      const rate = parseInt(playbackSpeed) / 100.0

      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      videoL.playbackRate = rate;
      videoR.playbackRate = rate;
    }

    function playSync()
    {
      onPlaybackSpeedChange(); // update rate

      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);

      playingCount += 2;
      updateUI();
      videoL.play().then(() => {
      },(e) => {
        playingCount--;
      });
      videoR.play().then(() => {
      },(e) => {
        playingCount--;
      });
    }
    function stopSync()
    {
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);

      // busyCounter++;
      // updateUI();

      // setTimeout(function() {
      //   playingCount = 0;

      //   refleshCurrentTime(videoL);
      //   videoL.requestVideoFrameCallback( ( x, frame ) => {
      //     const baseTime = frame.mediaTime;
      //     const duration = videoL.duration;
      //     const deltaTime = duration / videoFrames;
      //     const frameNumber = Math.round(baseTime / deltaTime);
      //     currentFrame = frameNumber;

      //     video_seek( videoR, baseTime, () => {
      //       busyCounter--; 
      //       updateUI();
      //     });
      //   });
      //   videoL.onpause = null;
      // }, 100);
      videoL.playbackRate = 0;
      videoR.playbackRate = 0;
      videoL.pause();
      videoR.pause();
      playingCount = 0;
      updateUI();
    }

    function onVideoEnd()
    {
      // onVideoEnd() may call after seeking to the end manually
      if( playingCount <= 0 )
      {
        return;
      }

      playingCount--;
      playingCount = Math.max( playingCount, 0 );

      if( playingCount == 0 )
      {
        setTimeout(playSync, 100);
      }
    }

    function refleshCurrentTime( video )
    {
      const step = video.duration / 3;
      if( video.duration / 2 <= video.currentTime )
      {
        video.currentTime -= step;
        video.currentTime += step;
      }
      else
      {
        video.currentTime += step;
        video.currentTime -= step;
      }
    }

    function video_seek( video, mediaTime, onSeekEnd, isFirst = true )
    {
      const duration = video.duration;
      const deltaTime = duration / videoFrames;

      // if( isFirst )
      //   video.currentTime = mediaTime + 0.01 /* magic number, somehow it is faster */;

      // refleshCurrentTime(video);
      // video.requestVideoFrameCallback( ( x, frame ) => {
      //   // console.log("seek " + video.currentTime);

      //   if( Math.abs(mediaTime - frame.mediaTime) < 0.01 )
      //   {
      //     onSeekEnd();
      //   }
      //   else
      //   {
      //     if( frame.mediaTime < mediaTime )
      //     {
      //       video.currentTime += deltaTime;
      //     }
      //     else{
      //       video.currentTime -= deltaTime;
      //     }
      //     video_seek( video, mediaTime, onSeekEnd, false );
      //   }
      // });

      // maybe enough
      video.currentTime = mediaTime + 0.01;
      onSeekEnd();
    }

    // from UI
    function framePrev()
    {
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);

      const duration = videoL.duration;
      const deltaTime = duration / videoFrames;
      const nextFrame = currentFrame - 1;
      if( nextFrame < 0 )
        return;
      
      busyCounter += 2;
      updateUI();

      // console.log( "currentFrame: " + currentFrame);
      // console.log( "nextFrame   : " + nextFrame);
      // console.log( "curT        : " + videoL.currentTime);
      // console.log( "nextT       : " + nextFrame * deltaTime);
      video_seek( videoR, nextFrame * deltaTime, () =>{ 
        const slider = document.getElementById("seekbar");
        slider.max = Math.round(duration / deltaTime) - 1;
        slider.value = nextFrame;

        currentFrame = nextFrame; busyCounter--; updateUI(); 
      });
      video_seek( videoL, nextFrame * deltaTime, () =>{ busyCounter--; updateUI(); });
    }
    function frameNext()
    {
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);

      const duration = videoL.duration;
      const deltaTime = duration / videoFrames;
      const nextFrame = currentFrame + 1;
      if( videoFrames <= nextFrame )
        return;
      
      busyCounter += 2;
      updateUI();

      // console.log( "currentFrame: " + currentFrame);
      // console.log( "nextFrame   : " + nextFrame);
      // console.log( "curT        : " + videoL.currentTime);
      // console.log( "nextT       : " + nextFrame * deltaTime);
      video_seek( videoR, nextFrame * deltaTime, () =>{ 
        const slider = document.getElementById("seekbar");
        slider.max = Math.round(duration / deltaTime) - 1;
        slider.value = nextFrame;
        currentFrame = nextFrame; busyCounter--; updateUI(); 
      });
      video_seek( videoL, nextFrame * deltaTime, () =>{ busyCounter--; updateUI(); });
    }

    $( "#playRange" ).slider({
      range: true,
      min: 0,
      max: 100,
      values: [ 25, 75 ],
      slide: function( event, ui ) {
        console.log($( "#playRange" ).slider("values"));
      }
    });
    $( ".ui-slider-range" ).css( "background-color", "blue" );
    $( ".ui-slider-handle" ).css( "background-color", "royalblue" );

    // from https://www.shadertoy.com/view/XtGGzG
    function magmaQuintic(x) {
      x = Math.max(0, Math.min(1, x));

      let x1 = [1.0, x, x * x, x * x * x]; // 1, x, x^2, x^3
      let x2 = [x1[3] * x, x1[3] * x * x]; // x^4, x^5

      function dot4(a, b) {
          return a[0] * b[0] + a[1] * b[1] + a[2] * b[2] + a[3] * b[3];
      }

      function dot2(a, b) {
          return a[0] * b[0] + a[1] * b[1];
      }

      // Calculate RGB components
      let r = dot4(x1, [-0.023226960, +1.087154378, -0.109964741, +6.333665763]) + dot2(x2, [-11.640596589, +5.337625354]);
      let g = dot4(x1, [+0.010680993, +0.176613780, +1.638227448, -6.743522237]) + dot2(x2, [+11.426396979, -5.523236379]);
      let b = dot4(x1, [-0.008260782, +2.244286052, +3.005587601, -24.279769818]) + dot2(x2, [+32.484310068, -12.688259703]);

      return [r, g, b];
    }
    function remap(value, inputMin, inputMax, outputMin, outputMax)
    {
        return (value - inputMin) * ((outputMax - outputMin) / (inputMax - inputMin)) + outputMin;
    }
    
    var bitmapImageL = null;
    var frameNumberL = -1;
    var bitmapImageR = null;
    var frameNumberR = -1;

    var psnrs = {};
        
    var heatmapMx = 0;
    var heatmapMy = 0;
    
    const heatmap = document.getElementById("heatmap");

    function updateHeatmap()
    {
      if(isHeatmapEnabled == false)
      {
        return;
      }
      
      const retinaScale = 1;
      heatmap.width = heatmap.getBoundingClientRect().width * retinaScale;
      heatmap.height = 32 * retinaScale;
      // heatmap.width = 2048;
      // heatmap.height = 32;
      const hctx = heatmap.getContext("2d");

      var maxPSNR = $('#MaxPSNR').val();
      var minPSNR = $('#MinPSNR').val();

      step = heatmap.width / videoFrames;
      for( let frameNumber = 0 ; frameNumber < videoFrames ; frameNumber++ )
      {
        const psnr = psnrs[frameNumber];
        if( psnr == undefined )
        {
          hctx.fillStyle = `rgb(0, 0, 0)`;
        }
        else
        {
          const color = magmaQuintic(remap(psnr, maxPSNR, minPSNR, 0, 1));
          hctx.fillStyle = `rgb(${color[0] * 255}, ${color[1] * 255}, ${color[2] * 255})`;
        }
        hctx.fillRect(step * frameNumber, 0, step, heatmap.height);
      }
      
      for( let frameNumber = 0 ; frameNumber < videoFrames ; frameNumber++ )
      {
        if( step * frameNumber < heatmapMx && heatmapMx < step * (frameNumber + 1) )
        {
          hctx.lineWidth = 2;
          hctx.strokeStyle = "cyan";
          const margin = 1;
          hctx.strokeRect( step * frameNumber, margin, step, heatmap.height-margin);

          const psnr = psnrs[frameNumber];
          if( psnr !== undefined )
          {
            hctx.fillStyle = "white";
            hctx.font = "16px Arial";
            hctx.lineWidth = 3;
            hctx.strokeStyle = "black";

            text = `PSNR: ${psnr.toFixed(2)}`;

            if(frameNumber < videoFrames * 0.5)
            {
              hctx.textAlign = "left";

              hctx.strokeText(text, step * (frameNumber + 1) + 10, heatmap.height * 0.5);
              hctx.fillText( text, step * (frameNumber + 1) + 10, heatmap.height * 0.5);
            }
            else
            {
              hctx.textAlign = "right";

              hctx.strokeText(text, step * frameNumber - 10, heatmap.height * 0.5);
              hctx.fillText( text, step * frameNumber - 10, heatmap.height * 0.5);
            }
          }
        }
      }
    }

    heatmap.addEventListener('mousemove', function(event) {
        const rect = heatmap.getBoundingClientRect();
        scaleX = heatmap.width / rect.width,
        scaleY = heatmap.height / rect.height;
        heatmapMx = ( event.clientX - rect.left ) * scaleX;
        heatmapMy = ( event.clientY - rect.top ) * scaleY;

        updateHeatmap();
    });
    heatmap.addEventListener('mousedown', function(event) {
      step = heatmap.width / videoFrames;
      frameNumber = Math.floor(heatmapMx / step);

      if( 0 <= frameNumber && frameNumber < videoFrames)
      {
        const slider = document.getElementById("seekbar");
        slider.value = frameNumber;
        currentFrame = frameNumber;
  
        updateUI(); 
        onSeekbarChange( slider.value );
      }
    });

    document.getElementById(image_L_idx).addEventListener('loadeddata', function() {
      psnrs = {};
      updateHeatmap();
    }, false);

    const worker = new Worker('worker.js');

    worker.addEventListener('message', (e) => {
      // console.log('Worker: ', e.data.PSNR);
      // console.log(`Delta time: ${performance.now() - e.data.queryTime} milliseconds`);
      psnrs[e.data.frame] = e.data.PSNR;
      updateHeatmap();
    }, false);

    function onFrameArrived( frame, video, videoLabel )
    {
      if(isHeatmapEnabled == false)
      {
        return;
      }

      const baseTime = frame.mediaTime;
      const duration = video.duration;
      const deltaTime = duration / videoFrames;
      const frameNumber = Math.round(baseTime / deltaTime);

      let startTime = performance.now();
      createImageBitmap(video).then(function (image) { 
        if( videoLabel == "L" )
        {
          bitmapImageL = image;
          frameNumberL = frameNumber;
        }
        else
        {
          bitmapImageR = image;
          frameNumberR = frameNumber;
        }

        if( frameNumberL == frameNumberR )
        {
          const scale = 2; // raw res calculation could be too much..
          const w = offScreenCanvas.width = image.width / scale;
          const h = offScreenCanvas.height = image.height / scale;
          const context = offScreenCanvas.getContext("2d", { willReadFrequently: true });
          context.save();
          context.drawImage(bitmapImageL, 0, 0, w, h);
          context.globalCompositeOperation = "difference";
          context.drawImage(bitmapImageR, 0, 0, w, h);
          context.restore();

          const imageData = context.getImageData(0, 0, w, h);
          const pixels = imageData.data;

          // var mseR = 0;
          // var mseG = 0;
          // var mseB = 0;
          // const numPixels = pixels.length / 4;
          // for( let i = 0; i < pixels.length; i += 4 ) {
          //     rd = pixels[i];
          //     gd = pixels[i+1];
          //     bd = pixels[i+2];
          //     mseR += rd * rd;
          //     mseG += gd * gd;
          //     mseB += bd * bd;
          // }
          // const mse = ( mseR + mseG + mseB ) / 3 / numPixels;
          // const maxI = 255
          // const PSNR = 10 * Math.log10( maxI * maxI / mse );
          // psnrs[frameNumberL] = PSNR;
          // console.log( `PSNR: ${PSNR}`);
          // updateHeatmap();

          worker.postMessage({
            frame: frameNumberL,
            pixels: pixels,
            queryTime: performance.now()
          }, [pixels.buffer]);
          
          // let endTime = performance.now();
          // console.log(`Execution time: ${endTime - startTime} milliseconds`);
        }
      });
    }
    
    function queryFrameL()
    {
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);

      videoL.requestVideoFrameCallback( ( x, frame ) => {
        const baseTime = frame.mediaTime;
        const duration = videoL.duration;
        const deltaTime = duration / videoFrames;
        const frameNumber = Math.round(baseTime / deltaTime);

        if( busyCounter == 0 )
        {
          const slider = document.getElementById("seekbar");
          slider.max = Math.round(duration / deltaTime) - 1;
          slider.value = frameNumber;

          currentFrame = frameNumber;

          updateUI(); 

          const enabledPlaybackRange = $('#playbackRange').is(':checked');
          if( enabledPlaybackRange && 0 < playingCount)
          {
            const theRange = $( "#playRange" ).slider("values");
            const begTime = theRange[0] / 100.0 * duration;
            const endTime = theRange[1] / 100.0 * duration;

            if( endTime < videoL.currentTime )
            {
              videoL.currentTime = begTime;
              videoR.currentTime = begTime;
            }
          }
        }

        onFrameArrived( frame, videoL, "L" );

        queryFrameL();
      });
    }
    queryFrameL();

    function queryFrameR()
    {
      const videoR = document.getElementById(image_R_idx);
      videoR.requestVideoFrameCallback( ( x, frame ) => {
        const baseTime = frame.mediaTime;
        const duration = videoR.duration;
        const deltaTime = duration / videoFrames;
        const frameNumber = Math.round(baseTime / deltaTime);

        // let startTime = performance.now();

        // offScreenCanvas.width = videoR.videoWidth;
        // offScreenCanvas.height = videoR.videoHeight;
        // const context = offScreenCanvas.getContext("2d", { willReadFrequently: true });
        // context.drawImage(videoR, 0, 0, offScreenCanvas.width, offScreenCanvas.height);
        // const imageData = context.getImageData(0, 0, offScreenCanvas.width, offScreenCanvas.height);

        // let endTime = performance.now();
        // console.log(`Execution time: ${endTime - startTime} milliseconds`);

        // let startTime = performance.now();
        // createImageBitmap(videoR).then(function (image) { 
        //   offScreenCanvas.width = image.width / 2;
        //   offScreenCanvas.height = image.height / 2;
        //   const context = offScreenCanvas.getContext("2d", { willReadFrequently: true });
        //   const imageData = context.getImageData(0, 0, offScreenCanvas.width, offScreenCanvas.height);
        //   let endTime = performance.now();
        //   console.log(`Execution time: ${endTime - startTime} milliseconds`);
        // });

        onFrameArrived( frame, videoR, "R" );

        queryFrameR();
      });
    }
    queryFrameR();

    function onSeekbarChange( value )
    {
      // busyCounter += 2;
      // updateUI();

      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      const duration = videoL.duration;
      const deltaTime = duration / videoFrames;

      // videoL.currentTime = deltaTime * value;

      // refleshCurrentTime(videoL);
      // videoL.requestVideoFrameCallback( ( x, frame ) => {
      //   const baseTime = frame.mediaTime;
      //   const duration = videoL.duration;
      //   const deltaTime = duration / videoFrames;
      //   const frameNumber = Math.round(baseTime / deltaTime);
      //   currentFrame = frameNumber;

      //   video_seek( videoR, baseTime, () => {
      //     console.log("seekend" + busyCounter);
      //     busyCounter--; updateUI();
      //   });
      // });
      
      video_seek( videoL, deltaTime * value, () => { });
      video_seek( videoR, deltaTime * value, () => { });
    }
    var selector_label_L = "#BeforeLabel";
    var selector_label_R = "#slider";

    $("#drop-zoneL").on("drop", function(e) {
        $(this).removeClass("dragover");
        handleDrop(e, image_L_idx, selector_label_L, '#filesL');
    });
    $("#drop-zoneR").on("drop", function(e) {
        $(this).removeClass("dragover");
        handleDrop(e, image_R_idx, selector_label_R, '#filesR');
    });

    function didChangeHideHandle(value) {
      $('.beer-handle').css('z-index', value ? -1 : 2);
    }
    function didChangeDifferenceMode(value) {
      $('.beer-reveal').css('mix-blend-mode', value ? "difference" : "unset");
    }

    $("#compare").prop('disabled', true);
    $("#buttonPlay").prop('disabled', true);
    $("#buttonStop").prop('disabled', true);
    $("#buttonPrev").prop('disabled', true);
    $("#buttonNext").prop('disabled', true);
    $("#seekbar").prop('disabled', true);

    $("#playRange").hide();
    
    function updateUI()
    {
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      const hasVideo = videoL.videoWidth > 0 && videoR.videoWidth > 0;

      const isBusy = busyCounter !== 0 || hasVideo === false;
      const isPlaying = playingCount > 0;

      $("#buttonPlay").prop('disabled', isBusy || isPlaying);
      $("#buttonStop").prop('disabled', !(hasVideo && isPlaying) || isBusy );
      $("#buttonPrev").prop('disabled', isBusy || isPlaying);
      $("#buttonNext").prop('disabled', isBusy || isPlaying);
      $("#frameLabel").html("frame: " + currentFrame);
      $("#seekbar").prop('disabled', isBusy || isPlaying);

      if( hasVideo )
      {
        $("#compare").prop('disabled', false);
      }

      const enabledPlaybackRange = $('#playbackRange').is(':checked');
      if( enabledPlaybackRange )
      {
        $("#playRange").show();
      }
      else
      {
        $("#playRange").hide();
      }

      updateCanvasLayout();
    }
    
    function compare()
    {
      $(".compContainer").css('display', '');

      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);

      offScreenCanvas.width = videoL.videoWidth;
      offScreenCanvas.height = videoL.videoHeight;
      const context = offScreenCanvas.getContext("2d");
      context.drawImage(videoL, 0, 0, offScreenCanvas.width, offScreenCanvas.height);
      const imageL = offScreenCanvas.toDataURL('image/png');

      $("#compL").unbind("load");
      $("#compL").bind('load', function(){
        beer.init();
      });
      $("#compL").attr("src", imageL);
      // $(selector_label).attr("data-beer-label", file.name);

      context.drawImage(videoR, 0, 0, offScreenCanvas.width, offScreenCanvas.height);
      const imageR = offScreenCanvas.toDataURL('image/png');
      $("#compR").unbind("load");
      $("#compR").bind('load', function(){
        beer.init();
      });
      $("#compR").attr("src", imageR);
    }

    // function flipLR() {
    //   var L = $(selector_image_L).attr("src");
    //   var R = $(selector_image_R).attr("src");
    //   $(selector_image_L).attr("src", R);
    //   $(selector_image_R).attr("src", L);

    //   var L_label = $(selector_label_L).attr("data-beer-label");
    //   var R_label = $(selector_label_R).attr("data-beer-label");
    //   $(selector_label_L).attr("data-beer-label", R_label);
    //   $(selector_label_R).attr("data-beer-label", L_label);
    // }
    document.addEventListener('keydown', function(event) {
      if( 0 < busyCounter )
      {
        return;
      }
      const videoL = document.getElementById(image_L_idx);
      const videoR = document.getElementById(image_R_idx);
      const hasVideo = videoL.videoWidth > 0 && videoR.videoWidth > 0;
      if( !hasVideo )
      {
        return;
      }

      // Left
      if (event.key.toLowerCase() === 'd')
      {
        framePrev();
      }
      // Right
      if (event.key.toLowerCase() === 'f')
      {
        frameNext();
      }

      // space
      if( event.keyCode == 32 )
      {
        const isPlaying = playingCount > 0;
        if(isPlaying)
        {
          stopSync();
        }
        else
        {
          playSync();
        }
        event.preventDefault();
      }
      // console.log("key" + event.keyCode );
  });
  </script>
</body>
</html>
